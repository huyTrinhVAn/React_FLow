<!DOCTYPE html>
<html>
<head>
    <title>Platform Metrics</title>
    <style>
        body { padding: 32px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ccc; padding: 8px 12px; text-align: left; }
        th { background: #870e40; color: #fff; }
        tr:nth-child(even) { background: #f9f9f9; }
        .group-header { background: #f5f5f5; cursor: pointer; font-weight: bold; padding: 12px; border-bottom: 2px solid #ddd; }
        .group-header:hover { background: #e9ecef; }
        .sub-header { margin-left: 24px; }
        .collapse-icon { font-size: 12px; margin-left: 8px; }
        .group-content { display: none; border-left: 3px solid #ddd; padding-left: 10px; margin-bottom: 10px; }
        .group-content.expanded { display: block; }
        .group-status { margin-right: 8px; padding:2px 10px; border-radius: 10px; font-size: 12px; }
        .status-healthy { background: green; color: #fff; }
        .status-unhealthy { background: red; color: #fff; }
        .group-pagination { margin-top: 8px; text-align: center; }
        .pagination-controls button { margin: 0 2px; }
    </style>
</head>
<body>
    <h2>Platform Metrics</h2>
    <div id="groupedView">Loading...</div>

    <!-- Handlebars Template -->
    <script id="group-template" type="text/x-handlebars-template">
        {{#each platforms}}
        <div>
            <div class="group-header" onclick="toggleCollapse('{{platformId}}')">
                <span>{{platform}} ({{totalItems}} items)</span>
                <span class="group-status status-{{overallStatus}}">{{overallStatus}}</span>
                <span class="collapse-icon" id="icon-{{platformId}}">▼</span>
            </div>
            <div class="group-content" id="content-{{platformId}}">
                {{#each subCategories}}
                <div>
                    <div class="group-header sub-header" onclick="toggleCollapse('{{subId}}')">
                        <span>{{name}}</span>
                        <span class="collapse-icon" id="icon-{{subId}}">▶</span>
                    </div>
                    <div class="group-content" id="content-{{subId}}">
                        <div id="sub-table-{{subId}}">Loading...</div>
                        <div class="group-pagination" id="pagination-{{subId}}"></div>
                    </div>
                </div>
                {{/each}}
            </div>
        </div>
        {{/each}}
    </script>

    <!-- Handlebars  -->
    <script src="https://cdn.jsdelivr.net/npm/handlebars@4.7.8/dist/handlebars.min.js"></script>
    <script>
    let groupSummary = [];
    let allData = [];
    let collapseState = {};
    const ITEMS_PER_PAGE = 10;

    // Helper to group by platform>sub-category
    function buildPlatformSubStructure(groupSummary, data) {
        const byPlat = {};
        data.forEach(e => {
            const plat = e.platform || "Unknown";
            const sub = e["sub-category"] || "Other";
            if(!byPlat[plat]) byPlat[plat] = new Set();
            byPlat[plat].add(sub);
        });
        return groupSummary.map(g => ({
            platform: g.platform,
            overallStatus: g.overallStatus,
            totalItems: g.totalItems,
            platformId: g.platform.replace(/[^a-zA-Z0-9]/g, "_"),
            subCategories: Array.from(byPlat[g.platform]||[]).map(name => ({
                name,
                subId: (g.platform+"_"+name).replace(/[^a-zA-Z0-9]/g, "_")
            }))
        }));
    }

    // Main render
    async function renderView() {
        const raw = await fetch('/platformmetrics').then(r=>r.json());
        if(!raw.success){document.getElementById('groupedView').innerHTML="Load error!";return;}
        groupSummary = raw.groupSummary;
        allData = raw.data;
        const platforms = buildPlatformSubStructure(groupSummary, allData);
        const tpl = Handlebars.compile(document.getElementById('group-template').innerHTML);
        document.getElementById('groupedView').innerHTML = tpl({platforms});

        // Optionally, auto-expand first platform for UX
        if(platforms.length) toggleCollapse(platforms[0].platformId);
    }

    // Toggle helpers
    window.toggleCollapse = function(id) {
        collapseState[id] = !collapseState[id];
        const content = document.getElementById('content-' + id);
        const icon = document.getElementById('icon-' + id);
        if (!content || !icon) return;
        if (collapseState[id]) {
            content.classList.add('expanded'); icon.textContent = '▼';
            // If platform, do nothing else. If sub, lazy load table on first expand
            if (id.indexOf("_") !== -1 && content.querySelector("table")==null) {
                const [platform, ...sub] = id.split("_");
                renderSubTable(platform, sub.join("_"), id, 1);
            }
        } else {
            content.classList.remove('expanded'); icon.textContent = '▶';
        }
    };

    // Render pagination and data for a subcategory
    function renderSubTable(platform, sub, subId, page) {
        // Filter data by platform and sub
        const items = allData.filter(item =>
            (item.platform||"Unknown").replace(/[^a-zA-Z0-9]/g,"_") === platform &&
            (item["sub-category"]||"Other").replace(/[^a-zA-Z0-9]/g,"_") === sub
        );
        const total = items.length;
        const totalPages = Math.ceil(total/ITEMS_PER_PAGE);
        const start = (page-1)*ITEMS_PER_PAGE;
        const pageItems = items.slice(start, start+ITEMS_PER_PAGE);

        let tableHtml = "<table><thead><tr><th>Account</th><th>Date</th><th>Item</th><th>Item Type</th><th>Reason</th><th>State</th><th>ID</th></tr></thead><tbody>";
        tableHtml += pageItems.map(item =>
            `<tr>
                <td>${item.account||""}</td>
                <td>${item.date||""}</td>
                <td>${item.item||""}</td>
                <td>${item.item_type||""}</td>
                <td>${item.reason||""}</td>
                <td style="color:${item.state==="Unhealthy"?"red":"green"}">${item.state||""}</td>
                <td>${item._id||""}</td>
            </tr>`).join('');
        tableHtml += "</tbody></table>";

        document.getElementById("sub-table-"+subId).innerHTML = tableHtml;

        // Pagination controls
        let p = `<div class="pagination-info">Showing ${start+1}-${Math.min(start+ITEMS_PER_PAGE,total)} of ${total} items</div>`;
        p += `<div class="pagination-controls">`;
        p += `<button onclick="renderSubTable('${platform}','${sub}','${subId}',1)" ${page==1?"disabled":""}>First</button>`;
        p += `<button onclick="renderSubTable('${platform}','${sub}','${subId}',${page-1})" ${page==1?"disabled":""}>Previous</button>`;
        p += `<span>Page ${page} of ${totalPages||1}</span>`;
        p += `<button onclick="renderSubTable('${platform}','${sub}','${subId}',${page+1})" ${page==totalPages||!totalPages?"disabled":""}>Next</button>`;
        p += `<button onclick="renderSubTable('${platform}','${sub}','${subId}',${totalPages})" ${page==totalPages||!totalPages?"disabled":""}>Last</button>`;
        p += `</div>`;
        document.getElementById("pagination-"+subId).innerHTML = totalPages>1 ? p : "";
    }

    document.addEventListener("DOMContentLoaded", renderView);
    </script>
</body>
</html>
