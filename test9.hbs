<!DOCTYPE html>
<html>
<head>
    <title>Platform Metrics</title>
    <link rel="stylesheet" href="/css/modal.css">
    <link rel="stylesheet" href="/css/datatables.css">
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            border: 1px solid #ccc;
            padding: 12px 15px;
            text-align: left;
        }
        
        th {
            background-color: #870e40;
            color: #f2f2f2;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .platform-header {
            background-color: #f5f5f5;
            cursor: pointer;
            padding: 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #ddd;
            margin-top: 10px;
        }

        .platform-header:hover {
            background-color: #e9ecef;
        }

        .sub-header {
            background-color: #f8f9fa;
            cursor: pointer;
            padding: 12px;
            padding-left: 30px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid #ddd;
            margin: 5px 0;
        }

        .sub-header:hover {
            background-color: #e9ecef;
        }

        .collapse-icon {
            font-size: 14px;
            margin-left: 10px;
        }

        .platform-content {
            display: none;
        }

        .platform-content.expanded {
            display: block;
        }

        .sub-content {
            display: none;
            margin-left: 20px;
            margin-bottom: 10px;
        }

        .sub-content.expanded {
            display: block;
        }

        .group-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin-left: 10px;
            font-weight: bold;
        }

        .status-healthy {
            background-color: green;
            color: white;
        }

        .status-unhealthy {
            background-color: red;
            color: white;
        }

        .sub-filters {
            background-color: #f8f9fa;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .sub-filters label {
            font-weight: bold;
            margin: 0;
        }

        .sub-filters input,
        .sub-filters select {
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        .sub-filters input {
            flex: 1;
            max-width: 300px;
        }

        .group-pagination {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
        }

        .pagination-info {
            margin-bottom: 10px;
            color: #666;
            font-size: 0.9rem;
        }

        .pagination-controls button {
            margin: 0 5px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            background-color: #fff;
            cursor: pointer;
            border-radius: 4px;
        }

        .pagination-controls button:hover {
            background-color: #f5f5f5;
        }

        .pagination-controls button:disabled {
            background-color: #f9f9f9;
            color: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h4 class="partialHeader">Platform Metrics</h4>

    <div id="dataView">
        <div class="loading">Loading...</div>
    </div>

    <!-- ========================================
         HANDLEBARS TEMPLATE - MAIN STRUCTURE
         ======================================== -->
    <script id="platforms-template" type="text/x-handlebars-template">
        \{{#each this}}
        <div>
            <!-- PLATFORM HEADER -->
            <div class="platform-header" data-platform="\{{platform}}" onclick="togglePlatform(this)">
                <div>
                    <span>\{{platform}} (\{{totalItems}} items)</span>
                    <span class="group-status status-\{{overallStatus}}">\{{capitalize overallStatus}}</span>
                </div>
                <span class="collapse-icon">‚ñ∂</span>
            </div>

            <!-- PLATFORM CONTENT -->
            <div class="platform-content">
                \{{#each subCategories}}
                <div>
                    <!-- SUB-CATEGORY HEADER -->
                    <div class="sub-header" data-platform="\{{../platform}}" data-subcategory="\{{name}}" data-subid="\{{subId}}" onclick="toggleSub(this)">
                        <div>
                            <span>\{{name}} (\{{count}} items)</span>
                            <span class="group-status status-\{{status}}">\{{capitalize status}}</span>
                        </div>
                        <span class="collapse-icon">‚ñ∂</span>
                    </div>

                    <!-- SUB-CATEGORY CONTENT -->
                    <div class="sub-content">
                        <!-- SEARCH & FILTER -->
                        <div class="sub-filters">
                            <label>Search:</label>
                            <input type="text" class="search-input" data-subid="\{{subId}}" placeholder="Search account, item..." onkeyup="searchGroup(this)">
                            
                            <label>Filter by State:</label>
                            <select class="filter-select" data-subid="\{{subId}}" onchange="filterGroup(this)">
                                <option value="">All States</option>
                                <option value="Healthy">Healthy</option>
                                <option value="Unhealthy">Unhealthy</option>
                            </select>
                        </div>

                        <!-- TABLE -->
                        <table>
                            <thead>
                                <tr>
                                    <th>Account</th>
                                    <th>Date</th>
                                    <th>Item</th>
                                    <th>Item Type</th>
                                    <th>State</th>
                                    <th>Reason</th>
                                </tr>
                            </thead>
                            <tbody class="data-tbody" data-subid="\{{subId}}">
                                <!-- Rows loaded here -->
                            </tbody>
                        </table>

                        <!-- PAGINATION -->
                        <div class="group-pagination" data-subid="\{{subId}}" style="display: none;">
                            <!-- Pagination controls rendered here -->
                        </div>
                    </div>
                </div>
                \{{/each}}
            </div>
        </div>
        \{{/each}}
    </script>

    <!-- ========================================
         HANDLEBARS TEMPLATE - TABLE ROWS
         ======================================== -->
    <script id="rows-template" type="text/x-handlebars-template">
        \{{#each this}}
        <tr>
            <td>\{{account}}</td>
            <td>\{{date}}</td>
            <td>\{{item}}</td>
            <td>\{{item_type}}</td>
            <td style="color: \{{#if (eq state 'Healthy')}}green\{{else}}red\{{/if}}">\{{state}}</td>
            <td>\{{reason}}</td>
        </tr>
        \{{/each}}
    </script>

    <!-- ========================================
         HANDLEBARS TEMPLATE - PAGINATION
         ======================================== -->
    <script id="pagination-template" type="text/x-handlebars-template">
        <div class="pagination-info">
            Showing \{{startItem}}-\{{endItem}} of \{{totalItems}} items
        </div>
        <div class="pagination-controls">
            <button onclick="goToPage(this, 1)" \{{#unless hasPreviousPage}}disabled\{{/unless}}>First</button>
            <button onclick="goToPage(this, \{{previousPage}})" \{{#unless hasPreviousPage}}disabled\{{/unless}}>Previous</button>
            <span style="margin: 0 10px;">Page \{{currentPage}} of \{{totalPages}}</span>
            <button onclick="goToPage(this, \{{nextPage}})" \{{#unless hasNextPage}}disabled\{{/unless}}>Next</button>
            <button onclick="goToPage(this, \{{totalPages}})" \{{#unless hasNextPage}}disabled\{{/unless}}>Last</button>
        </div>
    </script>

    <script src="https://cdn.jsdelivr.net/npm/handlebars@4.7.8/dist/handlebars.min.js"></script>

    <script>
        // ============================================
        // HANDLEBARS HELPERS
        // ============================================
        Handlebars.registerHelper('capitalize', (text) => {
            return text ? text.charAt(0).toUpperCase() + text.slice(1).toLowerCase() : '';
        });

        Handlebars.registerHelper('eq', (a, b) => a === b);

        // ============================================
        // API FUNCTIONS
        // ============================================
        async function fetchData(params = {}) {
            const queryParams = new URLSearchParams();
            
            Object.entries(params).forEach(([key, value]) => {
                if (value) queryParams.append(key, value);
            });

            const query = queryParams.toString() ? '?' + queryParams.toString() : '';
            
            try {
                console.log('üì• Fetching:', `/platformmetrics${query}`);
                const response = await fetch(`/platformmetrics${query}`);
                const data = await response.json();
                
                console.log('‚úÖ Response:', data);
                if (!data.success) throw new Error(data.error || 'Failed to fetch');
                
                return data;
            } catch (error) {
                console.error('‚ùå Fetch error:', error);
                throw error;
            }
        }

        // ============================================
        // DATA PROCESSING FUNCTIONS
        // ============================================
        function buildPlatformStructure(data, groupSummary) {
            console.log('üî® Building platform structure...');
            
            const grouped = {};
            data.forEach(item => {
                const platform = item.platform || 'Unknown';
                const sub = item['sub-category'] || 'Other';
                
                if (!grouped[platform]) grouped[platform] = {};
                if (!grouped[platform][sub]) grouped[platform][sub] = [];
                grouped[platform][sub].push(item);
            });

            const platforms = Object.keys(grouped).map(platform => {
                const summary = groupSummary.find(g => g.platform === platform);
                const totalItems = Object.values(grouped[platform]).reduce((sum, items) => sum + items.length, 0);
                
                const subCategories = Object.keys(grouped[platform]).map(sub => {
                    const items = grouped[platform][sub];
                    const hasUnhealthy = items.some(item => item.state === 'Unhealthy');
                    const subId = `${platform}_${sub}`.replace(/[^a-zA-Z0-9]/g, '_');
                    
                    return {
                        name: sub,
                        subId: subId,
                        count: items.length,
                        status: hasUnhealthy ? 'unhealthy' : 'healthy'
                    };
                });

                return {
                    platform: platform,
                    platformId: platform.replace(/[^a-zA-Z0-9]/g, '_'),
                    totalItems: totalItems,
                    overallStatus: summary?.overallStatus || 'unknown',
                    subCategories: subCategories
                };
            });

            console.log('‚úÖ Built:', platforms);
            return platforms;
        }

        // ============================================
        // RENDER FUNCTIONS (USING HANDLEBARS)
        // ============================================
        function renderPlatforms(platforms) {
            console.log('üìä Rendering platforms...');
            
            try {
                const template = Handlebars.compile(
                    document.getElementById('platforms-template').innerHTML
                );
                document.getElementById('dataView').innerHTML = template(platforms);
                console.log('‚úÖ Rendered!');
            } catch (error) {
                console.error('‚ùå Render error:', error);
                document.getElementById('dataView').innerHTML = 
                    `<div class="loading" style="color: red;">Error: ${error.message}</div>`;
            }
        }

        function renderTableRows(tbody, data) {
            const template = Handlebars.compile(
                document.getElementById('rows-template').innerHTML
            );
            tbody.innerHTML = template(data);
        }

        function renderPagination(container, paginationData, platform, sub, subId) {
            if (paginationData.totalPages <= 1) {
                container.style.display = 'none';
                return;
            }

            const { currentPage, totalPages, totalItems, itemsPerPage, hasNextPage, hasPreviousPage } = paginationData;
            const startItem = totalItems > 0 ? ((currentPage - 1) * itemsPerPage) + 1 : 0;
            const endItem = Math.min(currentPage * itemsPerPage, totalItems);

            const data = {
                startItem,
                endItem,
                totalItems,
                currentPage,
                totalPages,
                hasPreviousPage,
                hasNextPage,
                previousPage: currentPage - 1,
                nextPage: currentPage + 1,
                platform,
                sub,
                subId
            };

            const template = Handlebars.compile(
                document.getElementById('pagination-template').innerHTML
            );
            container.innerHTML = template(data);
            container.style.display = 'block';
        }

        // ============================================
        // UI INTERACTION FUNCTIONS
        // ============================================
        function togglePlatform(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.collapse-icon');
            const isExpanded = content.classList.contains('expanded');

            content.classList.toggle('expanded');
            icon.textContent = isExpanded ? '‚ñ∂' : '‚ñº';

            console.log('üîΩ Toggled platform:', header.dataset.platform);
        }

        function toggleSub(header) {
            const content = header.parentElement.querySelector('.sub-content');
            const icon = header.querySelector('.collapse-icon');
            const isExpanded = content.classList.contains('expanded');

            content.classList.toggle('expanded');
            icon.textContent = isExpanded ? '‚ñ∂' : '‚ñº';

            if (!isExpanded) {
                const tbody = content.querySelector('.data-tbody');
                if (tbody && !tbody.innerHTML.trim()) {
                    loadData(header.dataset.platform, header.dataset.subcategory, header.dataset.subid, 1);
                }
            }

            console.log('üîΩ Toggled sub:', header.dataset.subcategory);
        }

        async function loadData(platform, sub, subId, page = 1, search = '', state = '') {
            console.log('üì• Loading:', { platform, sub, page, search, state });

            const tbody = document.querySelector(`.data-tbody[data-subid="${subId}"]`);
            const pagination = document.querySelector(`.group-pagination[data-subid="${subId}"]`);

            if (!tbody) return;

            tbody.innerHTML = '<tr><td colspan="6" class="loading">Loading...</td></tr>';

            try {
                const params = { platform, 'sub-category': sub, page, limit: 10 };
                if (search) params.search = search;
                if (state) params.state = state;

                const result = await fetchData(params);

                if (!result.data?.length) {
                    tbody.innerHTML = '<tr><td colspan="6" class="loading">No items found</td></tr>';
                    if (pagination) pagination.style.display = 'none';
                    return;
                }

                renderTableRows(tbody, result.data);
                renderPagination(pagination, result.pagination, platform, sub, subId);
                console.log('‚úÖ Data loaded!');

            } catch (error) {
                console.error('‚ùå Load error:', error);
                tbody.innerHTML = `<tr><td colspan="6" class="loading">Error: ${error.message}</td></tr>`;
            }
        }

        function searchGroup(input) {
            const subId = input.dataset.subid;
            const filterSelect = document.querySelector(`.filter-select[data-subid="${subId}"]`);
            const [, platform, sub] = subId.match(/(.+?)_(.+)/) || [];
            
            loadData(platform, sub, subId, 1, input.value.trim(), filterSelect?.value || '');
        }

        function filterGroup(select) {
            const subId = select.dataset.subid;
            const searchInput = document.querySelector(`.search-input[data-subid="${subId}"]`);
            const [, platform, sub] = subId.match(/(.+?)_(.+)/) || [];
            
            loadData(platform, sub, subId, 1, searchInput?.value.trim() || '', select.value);
        }

        function goToPage(button, page) {
            const pagination = button.closest('.group-pagination');
            const subId = pagination.dataset.subid;
            const [, platform, sub] = subId.match(/(.+?)_(.+)/) || [];
            const searchInput = document.querySelector(`.search-input[data-subid="${subId}"]`);
            const filterSelect = document.querySelector(`.filter-select[data-subid="${subId}"]`);
            
            loadData(platform, sub, subId, page, searchInput?.value.trim() || '', filterSelect?.value || '');
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Initializing...');
            
            try {
                const result = await fetchData({ limit: 0 });
                
                if (!result.data?.length) {
                    document.getElementById('dataView').innerHTML = '<div class="loading">No data</div>';
                    return;
                }

                const platforms = buildPlatformStructure(result.data, result.groupSummary);
                renderPlatforms(platforms);
                
            } catch (error) {
                console.error('‚ùå Init error:', error);
                document.getElementById('dataView').innerHTML = 
                    `<div class="loading" style="color: red;">Error: ${error.message}</div>`;
            }
        });
    </script>
</body>
</html>
